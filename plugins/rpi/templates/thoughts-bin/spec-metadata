#!/usr/bin/env bash
set -euo pipefail

# Collect metadata
DATETIME_TZ=$(date '+%Y-%m-%d %H:%M:%S %Z')
FILENAME_TS=$(date '+%Y-%m-%d_%H-%M-%S')

if command -v git >/dev/null 2>&1 && git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
  REPO_ROOT=$(git rev-parse --show-toplevel)
  REPO_NAME=$(basename "$REPO_ROOT")
  GIT_BRANCH=$(git branch --show-current 2>/dev/null || git rev-parse --abbrev-ref HEAD)
  GIT_COMMIT=$(git rev-parse HEAD)
else
  REPO_ROOT=""
  REPO_NAME=""
  GIT_BRANCH=""
  GIT_COMMIT=""
fi

# GitHub info if available
GITHUB_URL=""
if command -v gh >/dev/null 2>&1 && gh auth status >/dev/null 2>&1; then
  GITHUB_INFO=$(gh repo view --json owner,name 2>/dev/null || echo "")
  if [ -n "$GITHUB_INFO" ]; then
    GITHUB_OWNER=$(echo "$GITHUB_INFO" | grep -o '"login":"[^"]*"' | head -1 | cut -d'"' -f4)
    GITHUB_REPO=$(echo "$GITHUB_INFO" | grep -o '"name":"[^"]*"' | head -1 | cut -d'"' -f4)
    [ -n "$GITHUB_OWNER" ] && [ -n "$GITHUB_REPO" ] && GITHUB_URL="https://github.com/${GITHUB_OWNER}/${GITHUB_REPO}"
  fi
fi

# Thoughts system status
THOUGHTS_STATUS=""
if command -v thoughts-status >/dev/null 2>&1; then
  THOUGHTS_STATUS=$(thoughts-status 2>/dev/null | head -n 40)
fi

# Print metadata
echo "Current Date/Time (TZ): $DATETIME_TZ"
[ -n "$GIT_COMMIT" ] && echo "Current Git Commit Hash: $GIT_COMMIT"
[ -n "$GIT_BRANCH" ] && echo "Current Branch Name: $GIT_BRANCH"
[ -n "$REPO_NAME" ] && echo "Repository Name: $REPO_NAME"
[ -n "$GITHUB_URL" ] && echo "GitHub URL: $GITHUB_URL"
echo "Timestamp For Filename: $FILENAME_TS"
if [ -n "$THOUGHTS_STATUS" ]; then
  echo ""
  echo "$THOUGHTS_STATUS"
fi
